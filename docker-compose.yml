services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: retrieval-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/127.0.0.1/6333 && echo -e 'GET /readyz HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && grep -q 'HTTP/1.1 200' <&3"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: retrieval-backend
    ports:
      - "8080:8080"
    volumes:
      # Persistent data (read-only)
      - ./data/images:/app/data/images:ro
      - ./data/audio:/app/data/audio:ro
      - ./data/pdfs:/app/data/pdfs:ro
      - ./data/pdf_images:/app/data/pdf_images:ro
      # Model cache (speeds up restarts)
      - model_cache:/root/.cache/huggingface
    environment:
      # Qdrant connection
      - RETRIEVAL_QDRANT_HOST=qdrant
      - RETRIEVAL_QDRANT_PORT=6333
      # GPU settings (falls back to CPU if unavailable)
      - RETRIEVAL_CLIP_DEVICE=cuda:1
      - RETRIEVAL_CLAP_DEVICE=cuda:1
      - RETRIEVAL_COLPALI_DEVICE=cuda:0
      # NVIDIA settings
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    # GPU support - use deploy section for Docker Compose v2.x
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: retrieval-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
    restart: unless-stopped
    profiles:
      - production

volumes:
  qdrant_data:
  model_cache:
